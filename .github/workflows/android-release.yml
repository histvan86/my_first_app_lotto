name: Android Release Build (APK only)

on:
  workflow_dispatch:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"

      - name: Flutter pub get
        run: flutter pub get

      # Írjunk local.properties-t, hogy a Gradle tudja hol az Android SDK és a Flutter SDK
      - name: Write android/local.properties
        run: |
          mkdir -p android
          cat > android/local.properties <<'EOF'
          sdk.dir=/usr/local/lib/android/sdk
          flutter.sdk=${FLUTTER_ROOT}
          EOF

      # Telepítünk egy sima Gradle-t (nincs wrapper a repo-ban)
      - name: Install Gradle 8.7
        run: |
          wget -q https://services.gradle.org/distributions/gradle-8.7-bin.zip
          unzip -q gradle-8.7-bin.zip
          echo "$PWD/gradle-8.7/bin" >> $GITHUB_PATH

      # Építés közvetlenül Gradle-lel
      - name: Build with Gradle (assembleRelease)
        working-directory: android
        run: gradle :app:assembleRelease --no-daemon

      # APK-k kilistázása, hogy lássuk a pontos útvonalat
      - name: Locate APK(s)
        run: |
          echo "Searching for APKs..."
          find android/app/build/outputs -type f -name "*.apk" -ls || true
